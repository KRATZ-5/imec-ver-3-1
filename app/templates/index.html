{% extends "layout.html" %}
{% block title %}Карта{% endblock %}
{% block content %}
  <!-- Подключение внешнего CSS -->
  <head>
    <link rel="stylesheet" href="/static/styles.css">
  </head>
  <h2 class="mb-4">Карта потребления электроэнергии регионами РФ</h2>

  <!-- Поиск региона -->
  <div class="search-container mb-4">
    <input type="text" id="region-search" placeholder="Поиск региона..." aria-label="Search region" />
    <button id="search-btn" type="button">Найти</button>
  </div>

  <!-- Слайдер и Play/Pause -->
  <div class="controls mb-4 flex items-center space-x-4">
    <div>
      <label for="year-range">Год: <span id="year-label">{{ max_year }}</span></label><br/>
      <input
        type="range"
        id="year-range"
        min="{{ min_year }}"
        max="{{ max_year }}"
        value="{{ max_year }}"
        step="1"
        disabled
      />
    </div>
    <button id="play-btn" type="button" disabled>▶️ Play</button>
    <button id="pause-btn" type="button" disabled>⏸ Pause</button>
  </div>

  <!-- Контейнер для карты -->
  <div id="map" class="w-full h-96 mb-4"></div>

  <!-- Инфопанель Top-5 / Bottom-5 -->
  <div id="info-panel" class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
    <div>
      <h3 class="font-bold mb-2">Top-5 регионов с наибольшим потреблением</h3>
      <table id="top5-table" class="w-full text-sm">
        <thead><tr><th class="text-left">Регион</th><th class="text-right">Потребление</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
    <div>
      <h3 class="font-bold mb-2">Top-5 регионов с наименьшим потреблением</h3>
      <table id="bottom5-table" class="w-full text-sm">
        <thead><tr><th class="text-left">Регион</th><th class="text-right">Потребление</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <!-- Leaflet и Chart.js -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet.heat/dist/leaflet-heat.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <script>
    const map = L.map('map', { center: [55.5, 37.6], zoom: 4 });
    const baseLayer = L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
      attribution: '&copy; CartoDB & OpenStreetMap'
    }).addTo(map);
    map.attributionControl.setPrefix('Custom Attribution');

    let geoData;
    let choroplethLayer = L.geoJSON().addTo(map);
    let changeLayer     = L.geoJSON().addTo(map);

    L.control.layers({ 'Базовая карта': baseLayer }, {
      'Градиент потребления': choroplethLayer,
      'Изменение к прошлому году': changeLayer
    }, { collapsed: false }).addTo(map);

    const yearRange = document.getElementById('year-range');
    const yearLabel = document.getElementById('year-label');
    const playBtn   = document.getElementById('play-btn');
    const pauseBtn  = document.getElementById('pause-btn');
    const searchBtn = document.getElementById('search-btn');
    const searchInput = document.getElementById('region-search');
    const MIN_YEAR = +yearRange.min, MAX_YEAR = +yearRange.max;
    let playInterval, debounceTimer;

    fetch('/api/regions')
      .then(r => r.json())
      .then(data => {
        geoData = data;
        yearRange.disabled = false;
        playBtn.disabled = false;
        updateData(+yearRange.value);
      })
      .catch(console.error);

    yearRange.addEventListener('input', () => {
      const y = +yearRange.value;
      yearLabel.textContent = y;
      clearTimeout(debounceTimer);
      debounceTimer = setTimeout(() => updateData(y), 300);
    });
    playBtn.addEventListener('click', () => {
      playBtn.disabled = true; pauseBtn.disabled = false;
      playInterval = setInterval(() => {
        let y = +yearRange.value;
        y = y < MAX_YEAR ? y + 1 : MIN_YEAR;
        yearRange.value = y;
        yearLabel.textContent = y;
        updateData(y);
      }, 1000);
    });
    pauseBtn.addEventListener('click', () => {
      clearInterval(playInterval);
      playBtn.disabled = false; pauseBtn.disabled = true;
    });
    searchBtn.addEventListener('click', () => {
      const term = searchInput.value.trim().toLowerCase();
      if (!geoData || !term) return;
      const feat = geoData.features.find(f => f.properties.name.toLowerCase().includes(term));
      if (feat) {
        const layer = L.geoJSON(feat, { style: { color: '#FFD700', weight: 3, fillOpacity: 0.3 } }).addTo(map);
        map.fitBounds(layer.getBounds(), { maxZoom: 6 });
        setTimeout(() => map.removeLayer(layer), 3000);
      } else alert('Регион не найден');
    });

    function updateData(year) {
      const prevYear = year - 1;
      Promise.all([
        fetch(`/api/consumption?period=${year}`).then(r => r.json()),
        fetch(`/api/consumption?period=${prevYear}`).then(r => r.json()).catch(() => [])
      ]).then(([currData, prevData]) => {
        const values = {}, prevValues = {};
        currData.forEach(o => values[o.region_code] = o.value);
        prevData.forEach(o => prevValues[o.region_code] = o.value);

        // Обновить Top5/Bottom5
        const items = currData.map(o => {
          const code = o.region_code;
          const name = geoData.features.find(f => f.properties.code === code)?.properties.name || code;
          const prev = prevValues[code] || 0;
          const val = o.value;
          const arrow = year > MIN_YEAR ? (val > prev ? '↑' : val < prev ? '↓' : '') : '';
          const color = arrow === '↑' ? 'text-green-500' : arrow === '↓' ? 'text-red-500' : '';
          return { code, name, value: val, prev, arrow, color };
        });
        items.sort((a,b) => b.value - a.value);
        const top5 = items.slice(0,5), bottom5 = items.slice(-5).reverse();
        const fmt = { minimumFractionDigits:1, maximumFractionDigits:1 };
        document.querySelector('#top5-table tbody').innerHTML = top5.map(i =>
          `<tr><td>${i.name}</td><td class="text-right">${i.value.toLocaleString(undefined,fmt)} млн кВт·ч <span class="font-bold ${i.color}">${i.arrow}</span></td></tr>`
        ).join('');
        document.querySelector('#bottom5-table tbody').innerHTML = bottom5.map(i =>
          `<tr><td>${i.name}</td><td class="text-right">${i.value.toLocaleString(undefined,fmt)} млн кВт·ч <span class="font-bold ${i.color}">${i.arrow}</span></td></tr>`
        ).join('');

        // Градиентный слой
        choroplethLayer.clearLayers();
        const maxV = Math.max(...Object.values(values), 0);
        L.geoJSON(geoData, {
          style: f => {
            const v = values[f.properties.code] || 0;
            return { fillColor: `rgba(255,0,0,${maxV? v/maxV:0})`, color:'#555', weight:1, fillOpacity:0.7 };
          },
          onEachFeature: featureInit
        }).addTo(choroplethLayer);

        // Слой сравнения
        changeLayer.clearLayers();
        L.geoJSON(geoData, {
          style: f => {
            const code = f.properties.code;
            const curr = values[code]||0, prev = prevValues[code]||0;
            const fill = curr>prev?'rgba(0,200,0,0.6)':curr<prev?'rgba(200,0,0,0.6)':'rgba(150,150,150,0.4)';
            return { fillColor:fill, color:'#333', weight:1, fillOpacity:0.7 };
          },
          onEachFeature: featureInit
        }).addTo(changeLayer);
      }).catch(console.error);
    }

    function featureInit(f, layer) {
      const code = f.properties.code;
      const name = f.properties.name;
      layer.bindTooltip(`<strong>${name}</strong>`);
      layer.on('click', () => {
        const cid = `chart-${code}-${Date.now()}`;
        layer.bindPopup(`<div class="chart-popup-wrapper"><h4>${name}</h4><canvas id="${cid}" class="chart-popup"></canvas></div>`,{maxWidth:350}).openPopup();
        map.on('popupopen', function onOpen(e){
          if(e.popup._source!==layer) return;
          map.off('popupopen', onOpen);
          fetch(`/api/consumption/history?region_code=${code}`)
            .then(r=>r.json()).then(full=>{
              full.sort((a,b)=>a.period-b.period);
              new Chart(document.getElementById(cid).getContext('2d'),{
                type:'line', data:{ labels:full.map(d=>d.period), datasets:[{label:'Потребление, млн кВт·ч', data:full.map(d=>d.value), fill:false,tension:0.3}]},
                options:{ scales:{ x:{ title:{display:true,text:'Год'}}, y:{ title:{display:true,text:'млн кВт·ч'}} }}
              });
            });
        });
      });
    }
  </script>
{% endblock %}
